<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aliy's Store | Calzado, ropa y accesorios por catálogo</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Oswald:wght@400;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/isotope-layout@3/dist/isotope.pkgd.min.js"></script>
  <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics-compat.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'md-primary': '#FF5277',
            'md-on-primary': '#FFFFFF',
            'md-primary-container': '#FFD9E2',
            'md-on-primary-container': '#660021',
            'md-secondary': '#5B4F7B',
            'md-on-secondary': '#FFFFFF',
            'md-secondary-container': '#E2D9FF',
            'md-on-secondary-container': '#1C0D37',
            'md-background': '#FFFBFE',
            'md-on-background': '#1D1B1F',
            'md-surface': '#FFFBFE',
            'md-on-surface': '#1D1B1F',
            'md-surface-variant': '#F3DDE3',
            'md-on-surface-variant': '#504147',
            'md-outline': '#837078',
            'md-surface-container-high': '#ECE6F0',
          },
          fontFamily: {
            'nunito': ['Nunito', 'sans-serif'],
            'oswald': ['Oswald', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <style>
    .catalog-grid {
      position: relative;
    }
    .catalog-item {
      width: calc(50% - 8px);
      margin-bottom: 16px;
      transition: transform 0.4s ease-out, opacity 0.4s ease-out;
    }
    .catalog-item.isotope-hidden {
      opacity: 0;
      transform: scale(0.001);
    }
    @media (min-width: 640px) {
       .catalog-item {
         width: calc(33.333% - 11px);
       }
    }
    @media (min-width: 1024px) {
       .catalog-item {
         width: calc(25% - 12px);
       }
    }
    @media (min-width: 1280px) {
       .catalog-item {
         width: calc(20% - 13px);
       }
    }
    @media (min-width: 1536px) {
       .catalog-item {
         width: calc(16.666% - 13px);
       }
    }
    .catalog-item .h-full {
     min-height: 250px;
    }
    .new-ribbon-wrapper {
        position: absolute;
        top: 0;
        right: 0;
        overflow: hidden;
        width: 100px;
        height: 100px;
        z-index: 10;
    }
    .new-ribbon-wrapper span {
        position: absolute;
        top: 20px;
        right: -30px;
        width: 120px;
        text-align: center;
        text-transform: uppercase;
        font-weight: bold;
        padding: 5px 0;
        background-color: #FF5277;
        color: #FFFFFF;
        transform: rotate(45deg);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
    }
    /* Styles for the filter buttons */
    .filter-button {
      padding: 8px 16px;
      border-radius: 9999px;
      font-weight: bold;
      transition: all 0.3s ease;
      background-color: transparent;
      border: 1px solid #837078;
      color: #504147;
    }
    .filter-button.active, .filter-button:hover {
      background-color: #FF5277;
      border-color: #FF5277;
      color: #FFFFFF;
    }
    /* NEW STYLES FOR SIDEBAR LINKS */
    .sidebar-link {
      padding: 8px 12px;
      border-radius: 8px;
      transition: all 0.3s ease;
      background-color: transparent;
      color: #504147;
      border: 1px solid transparent; /* Added for consistency */
    }
    .sidebar-link.active, .sidebar-link:hover {
      background-color: #FF5277;
      color: #FFFFFF;
    }
  </style>
</head>
<body class="bg-md-background font-nunito text-md-on-background">
  <div class="flex flex-col min-h-screen">
    <header class="bg-md-surface-variant p-5 flex justify-between items-center">
      <div class="md:hidden">
        <button id="menu-button" class="text-md-on-surface-variant">
          <i class="fas fa-bars text-xl"></i>
        </button>
      </div>
      <div class="flex items-center space-x-2">
        <span class="md:hidden text-2xl font-oswald font-bold text-md-on-surface-variant">Aliy's Store</span>
        <span class="hidden md:block text-2xl font-oswald font-bold text-md-on-surface-variant">Aliy's Store | Venta por catálogo</span>
      </div>
      <a href="#" id="whatsapp-contact-button" class="bg-transparent border border-md-outline text-md-on-surface-variant hover:bg-md-primary-container hover:text-md-on-primary-container active:bg-pink-100 font-bold py-2 px-4 rounded-full transition duration-300 flex items-center space-x-2">
        <i class="fab fa-whatsapp text-lg"></i>
        <span>Contacto</span>
      </a>
    </header>
    <div class="flex flex-col md:flex-row flex-grow">
      <div id="sidebar-overlay" class="fixed inset-0 bg-md-surface/50 hidden z-40 md:hidden"></div>
      <aside id="sidebar" class="bg-md-surface-variant p-5 flex-shrink-0 z-50 fixed inset-y-0 left-0 w-64 transform -translate-x-full transition-transform duration-300 md:relative md:w-48 md:transform-none md:block">
        <div class="text-right md:hidden">
            <button id="close-button" class="text-md-on-surface-variant">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <nav class="mt-8">
          <ul class="space-y-4">
            <li>
              <a href="#" class="sidebar-link block flex items-center space-x-2 active" data-filter="*">
                <i class="fas fa-th-large"></i>
                <span>Todo</span>
              </a>
            </li>
            <li>
              <a href="#" class="sidebar-link block flex items-center space-x-2" data-filter=".calzado">
                <i class="fas fa-shoe-prints"></i>
                <span>Calzado</span>
              </a>
              <ul class="ml-4 mt-2 space-y-2">
                <li><a href="#" class="sidebar-link block flex items-center space-x-2" data-filter=".dama"><i class="fas fa-female"></i><span>Dama</span></a></li>
                <li><a href="#" class="sidebar-link block flex items-center space-x-2" data-filter=".caballeros"><i class="fas fa-male"></i><span>Caballeros</span></a></li>
                <li><a href="#" class="sidebar-link block flex items-center space-x-2" data-filter=".niños"><i class="fas fa-child"></i><span>Niños</span></a></li>
                <li><a href="#" class="sidebar-link block flex items-center space-x-2" data-filter=".outlet"><i class="fas fa-tag"></i><span>Outlet</span></a></li>
              </ul>
            </li>
            <li>
              <a href="#" class="sidebar-link block flex items-center space-x-2" data-filter=".ropa">
                <i class="fas fa-tshirt"></i>
                <span>Ropa</span>
              </a>
            </li>
            <li>
              <a href="#" class="sidebar-link block flex items-center space-x-2" data-filter=".accesorios">
                <i class="fas fa-hat-cowboy"></i>
                <span>Accesorios</span>
              </a>
            </li>
            <li>
              <a href="#" class="sidebar-link block flex items-center space-x-2" data-filter=".hogar">
                <i class="fas fa-house"></i>
                <span>Hogar</span>
              </a>
            </li>
            <li>
              <a href="#" class="sidebar-link block flex items-center space-x-2" data-filter=".belleza-y-fragancias">
                <i class="fas fa-spa"></i>
                <span>Belleza y fragancias</span>
              </a>
            </li>
            <li>
              <a href="#" class="sidebar-link block flex items-center space-x-2" data-filter=".catalogos-especiales">
                <i class="fas fa-book-open"></i>
                <span>Catálogos especiales</span>
              </a>
            </li>
          </ul>

        </nav>
      </aside>
      <main class="flex-grow bg-md-background p-5">
        <div id="filter-container" class="mb-8 flex flex-wrap gap-2 justify-center">
            </div>
        
        <div id="catalog-grid" class="catalog-grid flex-wrap gap-4">
        </div>
      </main>
    </div>
    <footer class="bg-md-surface-container-high p-5 text-center text-md-on-surface-variant">
      Footer
    </footer>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDHxFawAx3IStuZefZtOj_yYRMCDj5V-Rk",
      authDomain: "formiik-dev.firebaseapp.com",
      projectId: "formiik-dev",
      storageBucket: "formiik-dev.firebasestorage.app",
      messagingSenderId: "91782576906",
      appId: "1:91782576906:web:f95afdbe0f80bfa58758f3",
      measurementId: "G-ZW7YPM60FN"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const analytics = firebase.analytics();

    const menuButton = document.getElementById('menu-button');
    const closeButton = document.getElementById('close-button');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const catalogGrid = document.getElementById('catalog-grid');
    const filterContainer = document.getElementById('filter-container');
    const whatsappButton = document.getElementById('whatsapp-contact-button');

    let catalogosData = [];
    let iso;

    // NEW CODE: Object to track the current active filters
    let filters = {
        brand: '*',
        category: '*'
    };

    menuButton.addEventListener('click', () => {
      sidebar.classList.remove('-translate-x-full');
      sidebarOverlay.classList.remove('hidden');
    });
    closeButton.addEventListener('click', () => {
      sidebar.classList.add('-translate-x-full');
      sidebarOverlay.classList.add('hidden');
    });
    sidebarOverlay.addEventListener('click', () => {
      sidebar.classList.add('-translate-x-full');
      sidebarOverlay.classList.add('hidden');
    });
    
    function registerCardClickEvent(eventName, catalogo) {
      analytics.logEvent(eventName, { 
        'event_category': 'catalogo',
        'event_action': 'click_card',
        'event_label': catalogo.nombre,
        'brand': catalogo.marca
      });
    }

    function registerWhatsappClickEvent() {
        analytics.logEvent('whatsapp_click', {
            'event_category': 'contacto',
            'event_action': 'click_whatsapp'
        });
    }

    whatsappButton.addEventListener('click', () => {
        registerWhatsappClickEvent();
    });

    // NEW CODE: Function to combine and apply the filters
    function applyFilters() {
        const combinedFilter = `${filters.category}${filters.brand}`;
        iso.arrange({ filter: combinedFilter });
        updateUrlParameter(filters.brand, filters.category);
    }
    
    // MODIFIED CODE: Update card creation to add category classes
    function displayCatalogos() {
        const grid = document.getElementById('catalog-grid');
        
        catalogosData.forEach(catalogo => {
            const categoryClasses = catalogo.categoria.map(cat => cat.replace(/\s+/g, '-').toLowerCase()).join(' ');
            
            const card = document.createElement('a');
            card.href = catalogo.url;
            card.target = "_blank";
            card.className = `group rounded-lg shadow-md hover:shadow-lg transition-transform hover:scale-105 duration-300 bg-md-surface flex flex-col overflow-hidden catalog-item ${catalogo.marca.replace(/\s+/g, '-').toLowerCase()} ${categoryClasses}`;
            
            if (catalogo.evento_ga) {
                card.addEventListener('click', () => {
                    registerCardClickEvent(catalogo.evento_ga, catalogo);
                });
            }

            const imageWrapper = document.createElement('div');
            imageWrapper.className = "relative w-full overflow-hidden";
            const image = document.createElement('img');
            image.src = catalogo.imagen;
            image.alt = `Portada de ${catalogo.nombre}`;
            image.className = "w-full h-full object-cover transition-transform duration-300 object-top";
            imageWrapper.appendChild(image);

            const textContainer = document.createElement('div');
            textContainer.className = "p-3 flex-grow text-center flex flex-col items-center";
            const title = document.createElement('h3');
            title.textContent = catalogo.nombre;
            title.className = "text-md font-bold font-oswald text-md-on-surface"; 
            textContainer.appendChild(title);

            card.appendChild(imageWrapper);
            card.appendChild(textContainer);
            grid.appendChild(card);
        });

        iso = new Isotope(grid, {
            itemSelector: '.catalog-item',
            layoutMode: 'masonry',
            masonry: {
                columnWidth: '.catalog-item',
                gutter: 16
            },
            getSortData: {
                name: '.font-oswald'
            },
            sortBy: 'name'
        });

        imagesLoaded(grid).on('progress', function() {
            iso.layout();
            checkUrlFilter();
        });
    }

    // MODIFIED CODE: Filter logic to use the new 'filters' object
    function createFilterButtons(brands) {
        const allButton = document.createElement('button');
        allButton.textContent = 'Todo';
        allButton.className = 'filter-button active';
        allButton.dataset.filter = '*';
        filterContainer.appendChild(allButton);

        brands.forEach(brand => {
            const button = document.createElement('button');
            button.textContent = brand;
            button.className = 'filter-button';
            button.dataset.filter = `.${brand.replace(/\s+/g, '-').toLowerCase()}`;
            filterContainer.appendChild(button);
        });
        
        filterContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('filter-button')) {
                document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                filters.brand = event.target.dataset.filter;
                applyFilters();
            }
        });
    }

    // MODIFIED CODE: Function to check and apply both brand and category filters from the URL
    function checkUrlFilter() {
        const urlParams = new URLSearchParams(window.location.search);
        const brandFromUrl = urlParams.get('brand');
        const categoryFromUrl = urlParams.get('category');

        if (brandFromUrl) {
            const filterButton = document.querySelector(`.filter-button[data-filter=".${brandFromUrl}"]`);
            if (filterButton) {
                document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
                filterButton.classList.add('active');
                filters.brand = `.${brandFromUrl}`;
            }
        }

        if (categoryFromUrl) {
            const sidebarLink = document.querySelector(`.sidebar-link[data-filter=".${categoryFromUrl}"]`);
            if (sidebarLink) {
                sidebarLinks.forEach(l => l.classList.remove('active'));
                sidebarLink.classList.add('active');
                filters.category = `.${categoryFromUrl}`;
            }
        }
        
        if (iso) {
            applyFilters();
        }
    }

    // MODIFIED CODE: Function to update the URL with both brand and category parameters
    function updateUrlParameter(brandName, categoryName) {
      const urlParams = new URLSearchParams(window.location.search);
      
      if (brandName === '*') {
          urlParams.delete('brand');
      } else {
          urlParams.set('brand', brandName.replace('.', ''));
      }

      if (categoryName === '*') {
          urlParams.delete('category');
      } else {
          urlParams.set('category', categoryName.replace('.', ''));
      }
      
      const newUrl = `${window.location.origin}${window.location.pathname}?${urlParams.toString()}`;
      window.history.replaceState({path: newUrl}, '', newUrl);
    }
    
    async function fetchCatalogos() {
        try {
            const catalogosRef = db.collection('catalogo');
            const snapshot = await catalogosRef.get();
            catalogosData = [];
            snapshot.forEach(doc => {
                catalogosData.push(doc.data());
            });

            catalogosData.sort((a, b) => a.nombre.localeCompare(b.nombre));

            const brands = [...new Set(catalogosData.map(item => item.marca).filter(Boolean))].sort();

            createFilterButtons(brands);

            displayCatalogos();

        } catch (error) {
            console.error("Error fetching documents: ", error);
        }
    }

    // NEW CODE: Event listener for sidebar links
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    sidebarLinks.forEach(link => {
        link.addEventListener('click', (event) => {
            event.preventDefault(); 
            sidebarLinks.forEach(l => l.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            const categoryValue = event.currentTarget.dataset.filter;
            filters.category = categoryValue;
            applyFilters();
        });
    });

    document.addEventListener('DOMContentLoaded', fetchCatalogos);
  </script>
</body>
</html>
